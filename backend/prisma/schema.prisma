generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String          @id @default(uuid())
  name           String
  subdomain      String          @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  contacts       Contact[]
  invoices       Invoice[]
  jobs           Job[]
  jobRecurrences JobRecurrence[]
  quotes         Quote[]
  services       Service[]
  users          User[]
  settings       TenantSettings?

  @@index([subdomain])
  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  cognitoId String   @unique
  email     String
  name      String
  tenantId  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([cognitoId])
  @@index([email])
  @@map("users")
}

model Contact {
  id             String          @id @default(uuid())
  tenantId       String
  firstName      String
  lastName       String
  email          String?
  phone          String?
  company        String?
  jobTitle       String?
  address        String?
  city           String?
  state          String?
  zipCode        String?
  country        String          @default("USA")
  tags           String[]        @default([])
  notes          String?
  status         String          @default("active")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices       Invoice[]
  jobs           Job[]
  jobRecurrences JobRecurrence[]
  quotes         Quote[]

  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@map("contacts")
}

model Quote {
  id          String          @id @default(uuid())
  tenantId    String
  quoteNumber String
  title       String?
  contactId   String
  subtotal    Decimal         @db.Decimal(10, 2)
  taxRate     Decimal         @default(0) @db.Decimal(5, 4)
  taxAmount   Decimal         @db.Decimal(10, 2)
  discount    Decimal         @default(0) @db.Decimal(10, 2)
  total       Decimal         @db.Decimal(10, 2)
  status      String          @default("draft")
  notes       String?
  validUntil  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  lineItems   QuoteLineItem[]
  contact     Contact         @relation(fields: [contactId], references: [id])
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jobs        Job[]

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([quoteNumber])
  @@map("quotes")
}

model QuoteLineItem {
  id          String   @id @default(uuid())
  quoteId     String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_line_items")
}

model Invoice {
  id             String            @id @default(uuid())
  tenantId       String
  invoiceNumber  String
  title          String?
  contactId      String
  subtotal       Decimal           @db.Decimal(10, 2)
  taxRate        Decimal           @default(0) @db.Decimal(5, 4)
  taxAmount      Decimal           @db.Decimal(10, 2)
  discount       Decimal           @default(0) @db.Decimal(10, 2)
  total          Decimal           @db.Decimal(10, 2)
  status         String            @default("draft")
  paymentStatus  String            @default("pending")
  approvalStatus String            @default("none")
  approvalAt     DateTime?
  notes          String?
  dueDate        DateTime?
  paymentTerms   String            @default("Net 30")
  paidAmount     Decimal           @default(0) @db.Decimal(10, 2)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lineItems      InvoiceLineItem[]
  contact        Contact           @relation(fields: [contactId], references: [id])
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments       Payment[]
  jobs           Job[]

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([paymentStatus])
  @@index([approvalStatus])
  @@index([invoiceNumber])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

model Payment {
  id          String   @id @default(uuid())
  tenantId    String
  invoiceId   String
  amount      Decimal  @db.Decimal(10, 2)
  paymentDate DateTime @default(now())
  method      String
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model Service {
  id              String          @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  duration        Int
  price           Decimal         @db.Decimal(10, 2)
  isActive        Boolean         @default(true)
  availability    Json?
  bookingSettings Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  jobs            Job[]
  jobRecurrences  JobRecurrence[]
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@map("services")
}

model Job {
  id           String         @id @default(uuid())
  tenantId     String
  title        String
  description  String?
  contactId    String
  serviceId    String?
  quoteId      String?
  invoiceId    String?
  recurrenceId String?
  startTime    DateTime
  endTime      DateTime
  status       String         @default("scheduled")
  location     String?
  price        Decimal?       @db.Decimal(10, 2)
  notes        String?
  assignedTo   String?
  breaks       Json?
  deletedAt    DateTime?
  archivedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  contact      Contact        @relation(fields: [contactId], references: [id])
  service      Service?       @relation(fields: [serviceId], references: [id])
  quote        Quote?         @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  invoice      Invoice?       @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  recurrence   JobRecurrence? @relation(fields: [recurrenceId], references: [id], onDelete: SetNull)
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([serviceId])
  @@index([quoteId])
  @@index([invoiceId])
  @@index([recurrenceId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([deletedAt])
  @@index([archivedAt])
  @@map("jobs")
}

model JobRecurrence {
  id          String   @id @default(uuid())
  tenantId    String
  contactId   String
  serviceId   String?
  title       String
  description String?
  location    String?
  notes       String?
  assignedTo  String?
  status      String   @default("active")
  frequency   String
  interval    Int
  count       Int?
  untilDate   DateTime?
  daysOfWeek  Int[]    @default([])
  startTime   DateTime
  endTime     DateTime
  timezone    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contact     Contact  @relation(fields: [contactId], references: [id])
  service     Service? @relation(fields: [serviceId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jobs        Job[]

  @@index([tenantId])
  @@index([contactId])
  @@index([serviceId])
  @@index([status])
  @@map("job_recurrences")
}

model Document {
  id         String   @id @default(uuid())
  tenantId   String
  fileName   String
  fileKey    String
  fileSize   Int
  mimeType   String
  entityType String
  entityId   String
  uploadedBy String
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("documents")
}

model TenantSettings {
  id                     String   @id @default(uuid())
  tenantId               String   @unique
  companyDisplayName     String?
  companySupportEmail    String?
  companyPhone           String?
  logoUrl                String?
  invoiceEmailSubject    String   @default("Your Invoice from {{company_name}}")
  invoiceEmailBody       String   @default("Hi {{customer_name}},\n\nPlease find attached invoice {{invoice_number}}.\n\nThank you for your business!")
  quoteEmailSubject      String   @default("Your Quote from {{company_name}}")
  quoteEmailBody         String   @default("Hi {{customer_name}},\n\nPlease find attached quote {{quote_number}}.\n\nWe look forward to working with you!")
  invoicePdfTemplateKey  String?
  quotePdfTemplateKey    String?
  updatedAt              DateTime @updatedAt
  updatedByUserId        String?
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_settings")
}
