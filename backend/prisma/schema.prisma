generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String    @id @default(uuid())
  name      String
  subdomain String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  contacts  Contact[]
  invoices  Invoice[]
  jobs      Job[]
  quotes    Quote[]
  services  Service[]
  users     User[]

  @@index([subdomain])
  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  cognitoId String   @unique
  email     String
  name      String
  tenantId  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([cognitoId])
  @@index([email])
  @@map("users")
}

model Contact {
  id        String    @id @default(uuid())
  tenantId  String
  firstName String
  lastName  String
  email     String?
  phone     String?
  company   String?
  jobTitle  String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String    @default("USA")
  tags      String[]  @default([])
  notes     String?
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices  Invoice[]
  jobs      Job[]
  quotes    Quote[]

  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@map("contacts")
}

model Quote {
  id          String          @id @default(uuid())
  tenantId    String
  quoteNumber String
  contactId   String
  subtotal    Decimal         @db.Decimal(10, 2)
  taxRate     Decimal         @default(0) @db.Decimal(5, 4)
  taxAmount   Decimal         @db.Decimal(10, 2)
  discount    Decimal         @default(0) @db.Decimal(10, 2)
  total       Decimal         @db.Decimal(10, 2)
  status      String          @default("draft")
  notes       String?
  validUntil  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  lineItems   QuoteLineItem[]
  contact     Contact         @relation(fields: [contactId], references: [id])
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([quoteNumber])
  @@map("quotes")
}

model QuoteLineItem {
  id          String   @id @default(uuid())
  quoteId     String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_line_items")
}

model Invoice {
  id            String            @id @default(uuid())
  tenantId      String
  invoiceNumber String
  contactId     String
  subtotal      Decimal           @db.Decimal(10, 2)
  taxRate       Decimal           @default(0) @db.Decimal(5, 4)
  taxAmount     Decimal           @db.Decimal(10, 2)
  discount      Decimal           @default(0) @db.Decimal(10, 2)
  total         Decimal           @db.Decimal(10, 2)
  status        String            @default("draft")
  paymentStatus String            @default("pending")
  notes         String?
  dueDate       DateTime?
  paymentTerms  String            @default("Net 30")
  paidAmount    Decimal           @default(0) @db.Decimal(10, 2)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  lineItems     InvoiceLineItem[]
  contact       Contact           @relation(fields: [contactId], references: [id])
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments      Payment[]

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([paymentStatus])
  @@index([invoiceNumber])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

model Payment {
  id          String   @id @default(uuid())
  tenantId    String
  invoiceId   String
  amount      Decimal  @db.Decimal(10, 2)
  paymentDate DateTime @default(now())
  method      String
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model Service {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  duration        Int
  price           Decimal  @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  availability    Json?
  bookingSettings Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  jobs            Job[]
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@map("services")
}

model Job {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  description String?
  contactId   String
  serviceId   String?
  startTime   DateTime
  endTime     DateTime
  status      String   @default("scheduled")
  location    String?
  notes       String?
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contact     Contact  @relation(fields: [contactId], references: [id])
  service     Service? @relation(fields: [serviceId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([serviceId])
  @@index([startTime])
  @@index([status])
  @@map("jobs")
}

model Document {
  id         String   @id @default(uuid())
  tenantId   String
  fileName   String
  fileKey    String
  fileSize   Int
  mimeType   String
  entityType String
  entityId   String
  uploadedBy String
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("documents")
}
